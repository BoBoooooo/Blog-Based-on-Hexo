---
title: å‰ç«¯è·¯ç”±çš„å‰ä¸–ä»Šç”Ÿ
date: 2018-11-13 14:48:32
tags: [vue , jquery]
categories: å‰ç«¯
---
# ä»€ä¹ˆæ˜¯è·¯ç”±

> åŸæ–‡åœ°å€:https://github.com/hwen/blogsome/issues/2

è·¯ç”±è¿™ä¸ªæ¦‚å¿µæœ€å…ˆæ˜¯åç«¯å‡ºç°çš„ã€‚åœ¨ä»¥å‰ç”¨æ¨¡æ¿å¼•æ“å¼€å‘é¡µé¢æ—¶ï¼Œç»å¸¸ä¼šçœ‹åˆ°è¿™æ ·
``` javascript
 // http://hometown.xxx.edu.cn/bbs/forum.php
```
æœ‰æ—¶è¿˜ä¼šæœ‰å¸¦.aspæˆ–.htmlçš„è·¯å¾„ï¼Œè¿™å°±æ˜¯æ‰€è°“çš„SSR(Server Side Render)ï¼Œé€šè¿‡æœåŠ¡ç«¯æ¸²æŸ“ï¼Œç›´æ¥è¿”å›é¡µé¢ã€‚

### å…¶å“åº”è¿‡ç¨‹æ˜¯è¿™æ ·çš„

* 1.æµè§ˆå™¨å‘å‡ºè¯·æ±‚

* 2.æœåŠ¡å™¨ç›‘å¬åˆ°80ç«¯å£ï¼ˆæˆ–443ï¼‰æœ‰è¯·æ±‚è¿‡æ¥ï¼Œå¹¶è§£æurlè·¯å¾„

* 3.æ ¹æ®æœåŠ¡å™¨çš„è·¯ç”±é…ç½®ï¼Œè¿”å›ç›¸åº”ä¿¡æ¯ï¼ˆå¯ä»¥æ˜¯ html å­—ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯ json æ•°æ®ï¼Œå›¾ç‰‡ç­‰ï¼‰

* 4.æµè§ˆå™¨æ ¹æ®æ•°æ®åŒ…çš„Content-Typeæ¥å†³å®šå¦‚ä½•è§£ææ•°æ®

 ç®€å•æ¥è¯´è·¯ç”±å°±æ˜¯ç”¨æ¥è·Ÿåç«¯æœåŠ¡å™¨è¿›è¡Œäº¤äº’çš„ä¸€ç§æ–¹å¼ï¼Œé€šè¿‡ä¸åŒçš„è·¯å¾„ï¼Œæ¥è¯·æ±‚ä¸åŒçš„èµ„æºï¼Œè¯·æ±‚ä¸åŒçš„é¡µé¢æ˜¯è·¯ç”±çš„å…¶ä¸­ä¸€ç§åŠŸèƒ½ã€‚

# å‰ç«¯è·¯ç”±çš„è¯ç”Ÿçš„ç¼˜ç”±

å‰ç«¯è·¯ç”±çš„å‡ºç°è¦ä» ajax å¼€å§‹ï¼Œä¸ºä»€ä¹ˆï¼Ÿä¸”å¬ä¸‹é¢åˆ†æ (Ë‰â–½ï¿£ï½)

Ajaxï¼Œå…¨ç§° Asynchronous JavaScript And XMLï¼Œæ˜¯æµè§ˆå™¨ç”¨æ¥å®ç°å¼‚æ­¥åŠ è½½çš„ä¸€ç§æŠ€æœ¯æ–¹æ¡ˆã€‚åœ¨ 90s å¹´ä»£åˆï¼Œå¤§å¤šæ•°çš„ç½‘é¡µéƒ½æ˜¯é€šè¿‡ç›´æ¥è¿”å› HTML çš„ï¼Œç”¨æˆ·çš„æ¯æ¬¡æ›´æ–°æ“ä½œéƒ½éœ€è¦é‡æ–°åˆ·æ–°é¡µé¢ã€‚åŠå…¶å½±å“äº¤äº’ä½“éªŒï¼Œéšç€ç½‘ç»œçš„å‘å±•ï¼Œè¿«åˆ‡éœ€è¦ä¸€ç§æ–¹æ¡ˆæ¥æ”¹å–„è¿™ç§æƒ…å†µã€‚

1996ï¼Œå¾®è½¯é¦–å…ˆæå‡º iframe æ ‡ç­¾ï¼Œiframe å¸¦æ¥äº†å¼‚æ­¥åŠ è½½å’Œè¯·æ±‚å…ƒç´ çš„æ¦‚å¿µï¼Œéšååœ¨ 1998 å¹´ï¼Œå¾®è½¯çš„ Outloook Web App å›¢é˜Ÿæå‡º Ajax çš„åŸºæœ¬æ¦‚å¿µï¼ˆXMLHttpRequestçš„å‰èº«ï¼‰ï¼Œå¹¶åœ¨ IE5 é€šè¿‡ ActiveX æ¥å®ç°äº†è¿™é¡¹æŠ€æœ¯ã€‚åœ¨å¾®è½¯å®ç°è¿™ä¸ªæ¦‚å¿µåï¼Œå…¶ä»–æµè§ˆå™¨æ¯”å¦‚ Moziliaï¼ŒSafariï¼ŒOpera ç›¸ç»§ä»¥ XMLHttpRequest æ¥å®ç° Ajaxã€‚ï¼ˆğŸ˜­ å…¼å®¹é—®é¢˜ä»æ­¤å‡ºç°ï¼Œè¯è¯´å¾®è½¯å‘½åçœŸå–œæ¬¢ç”¨Xï¼ŒMFCæºç ä¸€å¤§å †ã€‚ã€‚ï¼‰ä¸è¿‡åœ¨ IE7 å‘å¸ƒæ—¶ï¼Œå¾®è½¯é€‰æ‹©äº†å¦¥åï¼Œå…¼å®¹äº† XMLHttpRequest çš„å®ç°ã€‚

æœ‰äº† Ajax åï¼Œç”¨æˆ·äº¤äº’å°±ä¸ç”¨æ¯æ¬¡éƒ½åˆ·æ–°é¡µé¢ï¼Œä½“éªŒå¸¦æ¥äº†æå¤§çš„æå‡ã€‚

ä½†çœŸæ­£è®©è¿™é¡¹æŠ€æœ¯å‘æ‰¬å…‰å¤§çš„ï¼Œ(ï½¡ï½¥âˆ€ï½¥)ï¾‰ï¾è¿˜æ˜¯åæ¥çš„ Google Mapï¼Œå®ƒçš„å‡ºç°å‘äººä»¬å±•ç°äº† Ajax çš„çœŸæ­£é­…åŠ›ï¼Œé‡Šæ”¾äº†ä¼—å¤šå¼€å‘äººå‘˜çš„æƒ³è±¡åŠ›ï¼Œè®©å…¶ä¸ä»…ä»…å±€é™äºç®€å•çš„æ•°æ®å’Œé¡µé¢äº¤äº’ï¼Œä¸ºåæ¥å¼‚æ­¥äº¤äº’ä½“éªŒæ–¹å¼çš„ç¹è£å‘å±•å¸¦æ¥äº†æ ¹åŸºã€‚

è€Œå¼‚æ­¥äº¤äº’ä½“éªŒçš„æ›´é«˜çº§ç‰ˆæœ¬å°±æ˜¯ SPAï¼ˆé‚£ä¹ˆé—®ä¸ªé—®é¢˜ï¼Œå¼‚æ­¥äº¤äº’æœ€é«˜çº§çš„ä½“éªŒæ˜¯ä»€ä¹ˆï¼Ÿä¼šåœ¨æ–‡æœ«æ­æ™“ï¼‰â€”â€” å•é¡µåº”ç”¨ã€‚å•é¡µåº”ç”¨ä¸ä»…ä»…æ˜¯åœ¨é¡µé¢äº¤äº’æ˜¯æ— åˆ·æ–°çš„ï¼Œè¿é¡µé¢è·³è½¬éƒ½æ˜¯æ— åˆ·æ–°çš„ï¼Œä¸ºäº†å®ç°å•é¡µåº”ç”¨ï¼Œæ‰€ä»¥å°±æœ‰äº†å‰ç«¯è·¯ç”±ã€‚

å•é¡µåº”ç”¨çš„æ¦‚å¿µæ˜¯ä¼´éšç€ MVVM å‡ºç°çš„ã€‚æœ€æ—©ç”±å¾®è½¯æå‡ºï¼Œç„¶åä»–ä»¬åœ¨æµè§ˆå™¨ç«¯ç”¨ Knockoutjs å®ç°ã€‚ä½†è¿™é¡¹æŠ€æœ¯çš„å¼ºå¤§ä¹‹å¤„å¹¶æœªå½“æ—¶çš„å¼€å‘è€…ä½“ä¼šåˆ°ï¼Œå¯èƒ½æ˜¯å› ä¸º Knockoutjs å®ç°è¿‡äºå¤æ‚ï¼Œå¯¼è‡´æ²¡æœ‰å¤§é¢ç§¯çš„æ‰©æ•£ã€‚

åŒæ ·ï¼Œè¿™æ¬¡æ¥åŠ›çš„é€‰æ‰‹ä¾ç„¶æ˜¯ Googleã€‚Google é€šè¿‡ Angularjs å°† MVVM åŠå•é¡µåº”ç”¨å‘æ‰¬å…‰å¤§ï¼Œè®©å‰ç«¯å¼€å‘è€…èƒ½å¤Ÿå¼€å‘å‡ºæ›´åŠ å¤§å‹çš„åº”ç”¨ï¼ŒèŒèƒ½å˜å¾—æ›´å¤§äº†ã€‚ï¼ˆä¸å¾—ä¸æ„Ÿæ…¨ï¼Œå¾®è½¯ è·Ÿ Google éƒ½æ˜¯ä¼Ÿå¤§çš„å…¬å¸ï¼‰ã€‚éšåéƒ½æ˜¯å¤§å®¶éƒ½çŸ¥é“çš„æ•…äº‹ï¼Œå‰ç«¯åœˆå¼€å§‹å¾—åˆ°äº†çˆ†å‘å¼çš„å‘å±•ï¼Œé™†ç»­å‡ºç°äº†å¾ˆå¤šä¼˜ç§€çš„æ¡†æ¶ã€‚


# ä» vue-router æ¥çœ‹å‰ç«¯è·¯ç”±å®ç°åŸç†
å‰ç«¯è·¯ç”±çš„å®ç°å…¶å®å¾ˆç®€å•ã€‚

æœ¬è´¨ä¸Šå°±æ˜¯æ£€æµ‹ url çš„å˜åŒ–ï¼Œæˆªè· url åœ°å€ï¼Œç„¶åè§£ææ¥åŒ¹é…è·¯ç”±è§„åˆ™ã€‚

ä½†æ˜¯è¿™æ ·æœ‰äººå°±ä¼šé—®ï¼šurl æ¯æ¬¡å˜åŒ–éƒ½ä¼šåˆ·æ–°é¡µé¢å•Šï¼Ÿé¡µé¢éƒ½åˆ·æ–°äº†ï¼ŒJavaScript æ€ä¹ˆæ£€æµ‹å’Œæˆªè· urlï¼Ÿ

åœ¨ 2014 å¹´ä¹‹å‰ï¼Œå¤§å®¶æ˜¯é€šè¿‡ hash æ¥å®ç°è·¯ç”±ï¼Œurl hash å°±æ˜¯ç±»ä¼¼äº


> https://segmentfault.com/a/1190000011956628#articleHeader2


è¿™ç§ #ã€‚åé¢ hash å€¼çš„å˜åŒ–ï¼Œå¹¶ä¸ä¼šå¯¼è‡´æµè§ˆå™¨å‘æœåŠ¡å™¨å‘å‡ºè¯·æ±‚ï¼Œæµè§ˆå™¨ä¸å‘å‡ºè¯·æ±‚ï¼Œä¹Ÿå°±ä¸ä¼šåˆ·æ–°é¡µé¢ã€‚å¦å¤–æ¯æ¬¡ hash å€¼çš„å˜åŒ–ï¼Œè¿˜ä¼šè§¦å‘ hashchange è¿™ä¸ªäº‹ä»¶ï¼Œé€šè¿‡è¿™ä¸ªäº‹ä»¶æˆ‘ä»¬å°±å¯ä»¥çŸ¥é“ hash å€¼å‘ç”Ÿäº†å“ªäº›å˜åŒ–ã€‚

è®©æˆ‘ä»¬æ¥æ•´ç†æ€è·¯ï¼Œå‡å¦‚æˆ‘ä»¬è¦ç”¨ hash çš„æ¨¡å¼å®ç°ä¸€ä¸ªè·¯ç”±ï¼Œé‚£ä¹ˆæµç¨‹åº”è¯¥æ˜¯è¿™æ ·çš„ã€‚

## hash-mode

![State](https://user-images.githubusercontent.com/6712767/36025485-2ee8e22c-0dce-11e8-9af0-0b7b377a14fe.png)


hash çš„å®ç°ç›¸å¯¹æ¥è¯´è¦ç®€å•æ–¹ä¾¿äº›ï¼Œè€Œä¸”ä¸ç”¨æœåŠ¡å™¨æ¥æ”¯æŒã€‚

å¦å¤–æˆ‘ä»¬å¯ä»¥å‚è€ƒå‚è€ƒ vue-router è¿™ä¸€éƒ¨åˆ†çš„å®ç°ï¼ˆä¸ºäº†ä¾¿äºè§£é‡Šæˆ‘ç®€åŒ–äº†éƒ¨åˆ†ä»£ç ï¼‰

``` javascript
/**
 * æ·»åŠ  url hash å˜åŒ–çš„ç›‘å¬å™¨
 */
setupListeners () {
  const router = this.router

  /**
   * æ¯å½“ hash å˜åŒ–æ—¶å°±è§£æè·¯å¾„
   * åŒ¹é…è·¯ç”±
   */
  window.addEventListener('hashchange', () => {
    const current = this.current
    /**
     * transitionTo: 
     * åŒ¹é…è·¯ç”±
     * å¹¶é€šè¿‡è·¯ç”±é…ç½®ï¼ŒæŠŠæ–°çš„é¡µé¢ render åˆ° ui-view çš„èŠ‚ç‚¹
     */
    this.transitionTo(getHash(), route => {
      replaceHash(route.fullPath)
    })
  })
}
```

> æ£€æµ‹åˆ° hash çš„å˜åŒ–åï¼Œå°±å¯ä»¥é€šè¿‡æ›¿æ¢ DOM çš„æ–¹å¼æ¥å®ç°é¡µé¢çš„æ›´æ¢ã€‚

14å¹´åï¼Œå› ä¸ºHTML5æ ‡å‡†å‘å¸ƒã€‚å¤šäº†ä¸¤ä¸ª APIï¼ŒpushState å’Œ replaceStateï¼Œé€šè¿‡è¿™ä¸¤ä¸ª API å¯ä»¥æ”¹å˜ url åœ°å€ä¸”ä¸ä¼šå‘é€è¯·æ±‚ã€‚åŒæ—¶è¿˜æœ‰ onpopstate äº‹ä»¶ã€‚é€šè¿‡è¿™äº›å°±èƒ½ç”¨å¦ä¸€ç§æ–¹å¼æ¥å®ç°å‰ç«¯è·¯ç”±äº†ï¼Œä½†åŸç†éƒ½æ˜¯è·Ÿ hash å®ç°ç›¸åŒçš„ã€‚ç”¨äº† HTML5 çš„å®ç°ï¼Œå•é¡µè·¯ç”±çš„ url å°±ä¸ä¼šå¤šå‡ºä¸€ä¸ª#ï¼Œå˜å¾—æ›´åŠ ç¾è§‚ã€‚ä½†å› ä¸ºæ²¡æœ‰ # å·ï¼Œæ‰€ä»¥å½“ç”¨æˆ·åˆ·æ–°é¡µé¢ä¹‹ç±»çš„æ“ä½œæ—¶ï¼Œæµè§ˆå™¨è¿˜æ˜¯ä¼šç»™æœåŠ¡å™¨å‘é€è¯·æ±‚ã€‚ä¸ºäº†é¿å…å‡ºç°è¿™ç§æƒ…å†µï¼Œæ‰€ä»¥è¿™ä¸ªå®ç°éœ€è¦æœåŠ¡å™¨çš„æ”¯æŒï¼Œéœ€è¦æŠŠæ‰€æœ‰è·¯ç”±éƒ½é‡å®šå‘åˆ°æ ¹é¡µé¢ã€‚å…·ä½“å¯ä»¥è§ï¼šHTML5 histroy æ¨¡å¼

åŒæ ·ï¼Œæˆ‘ä»¬æ¥ç†æ¸…ä¸‹æ€è·¯ï¼Œè¿™æ ·å†™èµ·ä»£ç æ‰æ›´å¾—å¿ƒåº”æ‰‹~

## html5-mode

![State](https://user-images.githubusercontent.com/6712767/36025788-4ef185a0-0dcf-11e8-9dc3-629aba9024a1.png)


è¿™éƒ¨åˆ† vue-router çš„æºç ï¼Œå¯ä»¥å‘ç°å®ç°çš„æ€è·¯å¤§ä½“ä¹Ÿæ˜¯ç›¸åŒçš„
``` javascript

export class HTML5History extends History {
  constructor (router, base) {
    super(router, base)
    /**
     * åŸç†è¿˜æ˜¯è·Ÿ hash å®ç°ä¸€æ ·
     * é€šè¿‡ç›‘å¬ popstate äº‹ä»¶
     * åŒ¹é…è·¯ç”±ï¼Œç„¶åæ›´æ–°é¡µé¢ DOM
     */
    window.addEventListener('popstate', e => {
      const current = this.current

      // Avoiding first `popstate` event dispatched in some browsers but first
      // history route not updated since async guard at the same time.
      const location = getLocation(this.base)
      if (this.current === START && location === initLocation) {
        return
      }

      this.transitionTo(location, route => {
        if (supportsScroll) {
          handleScroll(router, route, current, true)
        }
      })
    })
  }

  go (n) {
    window.history.go(n)
  }

  push (location, onComplete, onAbort) {
    const { current: fromRoute } = this
    this.transitionTo(location, route => {
      // ä½¿ç”¨ pushState æ›´æ–° urlï¼Œä¸ä¼šå¯¼è‡´æµè§ˆå™¨å‘é€è¯·æ±‚ï¼Œä»è€Œä¸ä¼šåˆ·æ–°é¡µé¢
      pushState(cleanPath(this.base + route.fullPath))
      onComplete && onComplete(route)
    }, onAbort)
  }

  replace (location, onComplete, onAbort) {
    const { current: fromRoute } = this
    this.transitionTo(location, route => {
      // replaceState è·Ÿ pushState çš„åŒºåˆ«åœ¨äºï¼Œä¸ä¼šè®°å½•åˆ°å†å²æ ˆ
      replaceState(cleanPath(this.base + route.fullPath))
      onComplete && onComplete(route)
    }, onAbort)
  }
}

```